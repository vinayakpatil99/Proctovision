<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - ProctoVision.AI</title>
<link rel="icon" type="image/png" href="../images/logoprocto.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Inter',sans-serif;
  background:#f4f6fb;
  color:#333;
  display:flex;
  min-height:100vh;
}

/* SIDEBAR */
.sidebar{
  width:250px;
  background:linear-gradient(180deg,#2a2e5c,#3f51b5);
  color:#fff;
  display:flex;
  flex-direction:column;
  flex-shrink:0;
  box-shadow:3px 0 10px rgba(0,0,0,0.1);
}
.sidebar h2{
  text-align:center;
  margin:1.5em 0;
  font-size:1.8em;
  font-weight:700;
  letter-spacing:1px;
}
.sidebar nav a{
  display:flex;
  align-items:center;
  padding:1em 2em;
  color:#fff;
  text-decoration:none;
  font-weight:500;
  border-left:4px solid transparent;
  transition:all .3s ease;
}
.sidebar nav a i{margin-right:10px;font-size:1.2em;}
.sidebar nav a.active,.sidebar nav a:hover{
  background:rgba(255,255,255,0.15);
  border-left:4px solid #ff4081;
}

/* MAIN */
.main-content{
  flex:1;
  padding:2em;
  background:#f4f6fb;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2em;
}
header h1{font-size:1.8em;color:#3f51b5;font-weight:700;}

/* STATS */
.stats-container{
  display:flex;
  flex-wrap:wrap;
  gap:1.5em;
  margin-bottom:2em;
}
.stat-card{
  flex:1 1 250px;
  border-radius:10px;
  padding:1.5em;
  box-shadow:0 3px 10px rgba(0,0,0,0.08);
  position:relative;
  overflow:hidden;
  transition:all .3s ease;
  color:#fff;
  font-weight:600;
}
.stat-card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,0.15);}
.stat-card:nth-child(1){
  background:linear-gradient(135deg,#3f51b5,#5c6bc0);
  border-top:4px solid #673ab7;
}
.stat-card:nth-child(2){
  background:linear-gradient(135deg,#ff9800,#ffb74d);
  border-top:4px solid #ff9800;
}
.stat-card:nth-child(3){
  background:linear-gradient(135deg,#4caf50,#81c784);
  border-top:4px solid #4caf50;
}
.stat-card span{
  display:block;
  font-size:2em;
  font-weight:700;
  margin-top:.3em;
  color:#fff;
}

/* CHARTS */
.chart-row{
  display:flex;
  flex-wrap:wrap;
  gap:1.5em;
  margin-bottom:2em;
}
.chart-box{
  flex:1 1 400px;
  background:#fff;
  border-radius:10px;
  padding:1.5em;
  box-shadow:0 3px 10px rgba(0,0,0,0.08);
}
.chart-box h3{
  color:#3f51b5;
  margin-bottom:1em;
  font-weight:600;
  font-size:1.1em;
}

/* FORMS */
.notification-form,.invite-form{
  background:#fff;
  border-radius:10px;
  padding:2em;
  margin-bottom:2em;
  box-shadow:0 3px 10px rgba(0,0,0,0.08);
}
.notification-form h2,.invite-form h2{
  color:#3f51b5;font-size:1.4em;font-weight:600;margin-bottom:1em;
}
.notification-form select,
.notification-form textarea,
.notification-form button,
.invite-form select,
.invite-form input,
.invite-form button{
  width:100%;margin-bottom:1em;padding:.8em 1em;border-radius:8px;border:1px solid #ddd;font-size:1em;transition:all .3s ease;
}
.notification-form select:focus,
.notification-form textarea:focus,
.invite-form select:focus,
.invite-form input:focus{
  outline:none;border:1px solid #3f51b5;box-shadow:0 0 5px rgba(63,81,181,0.3);
}
.notification-form button,
.invite-form button{
  background:linear-gradient(90deg,#ff4081,#f50057);
  color:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
  transition:all .3s ease;
}
.notification-form button:hover,
.invite-form button:hover{background:linear-gradient(90deg,#f50057,#d81b60);}

/* MODAL */
#logoutModal{
  display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;
}
#logoutModal>div{
  background:#fff;padding:2em;border-radius:12px;max-width:400px;width:90%;
  text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
#logoutModal h3{color:#3f51b5;font-size:1.4em;margin-bottom:.5em;}
#logoutModal p{color:#555;margin-bottom:1.5em;}
#logoutModal button{padding:.7em 1.5em;border:none;border-radius:8px;font-weight:600;cursor:pointer;}
#cancelLogout{background:#ccc;color:#333;}
#confirmLogout{background:#f44336;color:#fff;}
#cancelLogout:hover{background:#bdbdbd;}
#confirmLogout:hover{background:#d32f2f;}

/* RESPONSIVE */
@media(max-width:768px){
  body{flex-direction:column;}
  .sidebar{width:100%;flex-direction:row;overflow-x:auto;}
  .sidebar nav a{flex:1;justify-content:center;padding:.8em;}
  .stats-container{flex-direction:column;}
  .chart-row{flex-direction:column;}
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Admin</h2>
  <nav>
    <a href="dashboard.html" class="active"><i>üè†</i>Dashboard</a>
    <a href="exams.html"><i>üìù</i>Exams</a>
    <a href="questions.html"><i>‚ùì</i>All Questions</a>
    <a href="add-question.html"><i>‚ûï</i>Add Question</a>
    <a href="results.html"><i>üìä</i>Results</a>
    <a href="proctoring.html"><i>üé•</i>Proctoring</a>
    <a href="../login.html" id="logoutBtn"><i>üö™</i>Logout</a>
  </nav>
</div>

<!-- MAIN -->
<div class="main-content">
  <header><h1>Dashboard Overview</h1></header>

  <div class="stats-container">
    <div class="stat-card">Total Students: <span id="total-students">0</span></div>
    <div class="stat-card">Total Exams: <span id="total-exams">0</span></div>
    <div class="stat-card">Results Recorded: <span id="total-results">0</span></div>
  </div>

  <!-- CHARTS -->
  <div class="chart-row">
    <div class="chart-box">
      <h3>On Site Status</h3>
      <canvas id="donutChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Exam Performance</h3>
      <canvas id="lineChart"></canvas>
    </div>
  </div>

  <!-- FORMS -->
  <div class="notification-form">
    <h2>Send Notification</h2>
    <select id="studentSelect"><option value="">Select Student</option></select>
    <textarea id="notifMessage" placeholder="Type your message here..."></textarea>
    <button id="sendNotifBtn">Send Notification</button>
  </div>

  <div class="invite-form">
    <h2>Send Exam Invite (External Student)</h2>
    <label for="examSelect" style="display:block;margin-bottom:0.5em;color:#555;font-weight:500;">Select Exam</label>
    <select id="examSelect"><option value="">Select Exam</option></select>
    <label for="inviteEmail" style="display:block;margin-bottom:0.5em;color:#555;font-weight:500;">Enter Student's Email</label>
    <input type="email" id="inviteEmail" placeholder="student@example.com" required>
    <button id="sendInviteBtn">Send Invite</button>
  </div>
</div>

<!-- LOGOUT MODAL -->
<div id="logoutModal">
  <div>
    <h3>Confirm Logout</h3>
    <p>Are you sure you want to log out?</p>
    <div style="display:flex;justify-content:center;gap:15px;">
      <button id="cancelLogout">Cancel</button>
      <button id="confirmLogout">Logout</button>
    </div>
  </div>
</div>

<script>
// === Existing logic ===

// Fetch total exams
fetch("http://localhost:9090/api/admin/exams")
  .then(res => res.json())
  .then(data => {
    document.getElementById("total-exams").textContent = Array.isArray(data) ? data.length : 0;
    const examSelect = document.getElementById("examSelect");
    examSelect.innerHTML = '<option value="">Select Exam</option>';
    data.forEach(exam => {
      const opt = document.createElement("option");
      opt.value = exam.id;
      opt.textContent = exam.title;
      examSelect.appendChild(opt);
    });
  });

// ‚úÖ Updated: Fetch total results correctly
fetch("http://localhost:9090/api/results/all")
  .then(res => res.json())
  .then(data => {
    document.getElementById("total-results").textContent = Array.isArray(data) ? data.length : 0;
  })
  .catch(err => {
    console.error("Error fetching results:", err);
    document.getElementById("total-results").textContent = "0";
  });

// Fetch total students
fetch("http://localhost:9090/api/admin/students")
  .then(res => res.json())
  .then(students => {
    const select = document.getElementById("studentSelect");
    select.innerHTML = '<option value="">Select Student</option>';
    students.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.username;
      select.appendChild(opt);
    });
    document.getElementById("total-students").textContent = students.length;
  });

// Send notification
document.getElementById("sendNotifBtn").addEventListener("click", () => {
  const studentId = document.getElementById("studentSelect").value;
  const message = document.getElementById("notifMessage").value.trim();
  if (!studentId) return alert("Please select a student");
  if (!message) return alert("Enter a message");

  fetch(`http://localhost:9090/api/notifications/send?studentId=${studentId}&message=${encodeURIComponent(message)}`, {
    method: "POST"
  })
  .then(res => res.json())
  .then(data => {
    alert("Notification sent to " + (data.student?.username || "student"));
    document.getElementById("notifMessage").value = "";
    document.getElementById("studentSelect").value = "";
  });
});

// Send invite
document.getElementById("sendInviteBtn").addEventListener("click", () => {
  const examId = document.getElementById("examSelect").value;
  const email = document.getElementById("inviteEmail").value.trim();
  if (!examId) return alert("Please select an exam");
  if (!email) return alert("Please enter an email");

  fetch(`http://localhost:9090/invite/send?examId=${examId}&email=${encodeURIComponent(email)}`, {
    method: "POST"
  })
  .then(res => res.text())
  .then(msg => {
    alert(msg);
    if (msg.startsWith("Invite sent successfully")) {
      document.getElementById("inviteEmail").value = "";
      document.getElementById("examSelect").value = "";
    }
  });
});

// Logout modal
const logoutBtn=document.getElementById("logoutBtn");
const logoutModal=document.getElementById("logoutModal");
const cancelLogout=document.getElementById("cancelLogout");
const confirmLogout=document.getElementById("confirmLogout");

logoutBtn.addEventListener("click", e=>{ e.preventDefault(); logoutModal.style.display="flex"; });
cancelLogout.addEventListener("click", ()=> logoutModal.style.display="none");
confirmLogout.addEventListener("click", ()=>{ localStorage.clear(); window.location.href="../login.html"; });
window.addEventListener("click", e=>{ if(e.target===logoutModal) logoutModal.style.display="none"; });

// Charts
const donutCtx=document.getElementById('donutChart').getContext('2d');
new Chart(donutCtx,{
  type:'doughnut',
  data:{
    labels:['On Site','Offline','Pending'],
    datasets:[{data:[120,80,40],backgroundColor:['#ff4081','#3f51b5','#ffb300'],borderWidth:0}]
  },
  options:{plugins:{legend:{display:true,position:'bottom'}},cutout:'70%'}
});

const lineCtx=document.getElementById('lineChart').getContext('2d');
new Chart(lineCtx,{
  type:'line',
  data:{
    labels:['Jan','Feb','Mar','Apr','May','Jun'],
    datasets:[
      {label:'Active Exams',data:[150,200,180,250,300,280],borderColor:'#3f51b5',backgroundColor:'rgba(63,81,181,0.15)',fill:true,tension:.4},
      {label:'Completed Exams',data:[100,180,160,230,280,260],borderColor:'#ff4081',backgroundColor:'rgba(255,64,129,0.15)',fill:true,tension:.4}
    ]
  },
  options:{plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true}}}
});
</script>

</body>
</html>
