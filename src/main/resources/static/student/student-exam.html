<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProctoVision | Student Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Poppins',sans-serif;background:#f9fafc;color:#1e293b;margin:0;min-height:100vh;}
    h3,h4,h5{color:#0f172a;font-weight:600;}
    .container{padding-top:40px;}
    .exam-list .card{border:1px solid #e2e8f0;border-radius:10px;background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);transition:all 0.25s ease;}
    .exam-list .card:hover{transform:translateY(-3px);box-shadow:0 4px 10px rgba(0,0,0,0.08);}
    .btn-start{background-color:#0ea5e9;border:none;color:#fff;font-weight:500;border-radius:6px;transition:background 0.3s ease;}
    .btn-start:hover{background-color:#0284c7;}
    .exam-container{max-width:900px;margin:50px auto;background:#fff;border-radius:10px;border:1px solid #e5e7eb;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);padding:35px 45px;display:none;animation:fadeIn 0.4s ease;}
    .exam-header{display:flex;justify-content:space-between;align-items:center;
      margin-bottom:25px;border-bottom:1px solid #e2e8f0;padding-bottom:15px;}
    .timer{background:#e0f2fe;color:#0369a1;padding:10px 20px;border-radius:6px;font-weight:600;font-size:16px;}
    .question{background:#f9fafb;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:25px;transition:box-shadow 0.3s ease;}
    .question:hover{box-shadow:0 2px 8px rgba(14,165,233,0.1);}
    .option-label{display:block;background:#fff;padding:10px 15px;margin:8px 0;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer;transition:0.2s ease;}
    .option-label:hover{background:#e0f7ff;border-color:#0ea5e9;}
    input[type="radio"]{accent-color:#0ea5e9;margin-right:10px;}
    textarea{width:100%;background:#fff;border:1px solid #cbd5e1;color:#0f172a;
      border-radius:6px;padding:10px;resize:vertical;}
    .submit-btn{width:100%;background:#0ea5e9;color:white;border:none;
      padding:12px;border-radius:8px;font-size:16px;font-weight:600;transition:0.3s;}
    .submit-btn:hover{background:#0284c7;}
    .no-exam-box{background:#ffffff;border-radius:12px;padding:60px;text-align:center;
      border:1px solid #e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .no-exam-box img{width:110px;opacity:0.7;margin-bottom:20px;}
    .no-exam-box h5{color:#64748b;font-weight:500;}
    #cameraPreview{position:fixed;top:10px;right:10px;width:180px;height:140px;background:#000;
      border-radius:10px;overflow:hidden;border:2px solid #0ea5e9;display:none;z-index:2000;}
    #cameraPreview video{width:100%;height:100%;object-fit:cover;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  </style>
</head>
<body>

  <div id="cameraPreview"><video autoplay muted></video></div>

  <div id="examListContainer" class="container exam-list">
    <h3 class="mb-4 text-center">ðŸ§  Assigned Exams</h3>
    <div id="examList" class="row g-4"></div>
  </div>

  <div class="exam-container">
    <div class="exam-header">
      <div>
        <h4 id="examTitle">Exam Title</h4>
        <small id="examDuration" class="text-muted"></small>
      </div>
      <div class="timer" id="timer">--:--</div>
    </div>
    <div id="questionContainer"></div>
    <button class="submit-btn mt-3" id="submitExamBtn">Submit Exam</button>
  </div>

  <script>
    const studentId = localStorage.getItem('studentId') || 1;
    const apiBase = 'http://localhost:9090/api/exams';
    let examId = null, remainingMinutes = 0, timerInterval;

    // âœ… Load assigned exams
    async function loadAssignedExams() {
      try {
        const res = await fetch(`${apiBase}/assignedList?studentId=${studentId}`);
        const exams = await res.json();
        const listDiv = document.getElementById('examList');
        listDiv.innerHTML = '';
        if (!Array.isArray(exams) || exams.length === 0) {
          listDiv.innerHTML = `<div class="col-12"><div class="no-exam-box">
            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png">
            <h5>No active exams assigned today.</h5></div></div>`;
          return;
        }
        exams.forEach(exam => {
          const card = document.createElement('div');
          card.classList.add('col-md-4');
          card.innerHTML = `
            <div class="card p-3 h-100 text-center">
              <h5>${exam.title}</h5>
              <p class="text-muted mb-1"><b>Date:</b> ${exam.examDate}</p>
              <p class="text-muted"><b>Duration:</b> ${exam.durationMinutes} mins</p>
              <button class="btn btn-start w-100 mt-auto" onclick="startSpecificExam(${exam.id})">Start Exam</button>
            </div>`;
          listDiv.appendChild(card);
        });
      } catch (err) {
        alert('Error loading exams: ' + err.message);
      }
    }

    // âœ… Start Exam
    async function startSpecificExam(selectedExamId) {
      examId = selectedExamId;
      try {
        await startProctoringMode();
        const res = await fetch(`${apiBase}/${examId}/startAndFetch?studentId=${studentId}`, { method: 'POST' });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        document.getElementById('examListContainer').style.display = 'none';
        document.querySelector('.exam-container').style.display = 'block';
        renderExam(data);
        startTimer(data.remainingTime);
      } catch (err) {
        alert(err.message || 'Unable to start exam.');
      }
    }

    // âœ… Enable Proctoring
    async function startProctoringMode() {
      try {
        const el = document.documentElement;
        if (el.requestFullscreen) await el.requestFullscreen();

        const cam = document.getElementById('cameraPreview');
        const video = cam.querySelector('video');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        cam.style.display = 'block';

        document.addEventListener('fullscreenchange', () => {
          if (!document.fullscreenElement) logViolation("Exited fullscreen");
        });
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) logViolation("Switched tab/minimized");
        });
      } catch (err) {
        alert("Camera access required for proctoring.");
        throw err;
      }
    }

    // âœ… Render questions
    function renderExam(data) {
      document.getElementById('examTitle').textContent = data.examInfo.title;
      document.getElementById('examDuration').textContent = `Duration: ${data.examInfo.durationMinutes} mins`;
      remainingMinutes = data.remainingTime;
      const qContainer = document.getElementById('questionContainer');
      qContainer.innerHTML = '';
      data.questionsList.forEach((q, i) => {
        const qDiv = document.createElement('div');
        qDiv.classList.add('question');
        qDiv.innerHTML = `<h5>Q${i + 1}. ${q.title}</h5>${renderOptions(q)}`;
        qContainer.appendChild(qDiv);
      });
    }

    function renderOptions(question) {
      if (!question.options || question.options.length === 0) {
        return `<textarea placeholder="Write your answer..." onchange="saveAnswer(${question.examId}, ${question.id}, this.value)"></textarea>`;
      }
      return question.options.map(opt => `
        <label class="option-label">
          <input type="radio" name="question_${question.id}" value="${opt}" onchange="saveAnswer(${question.examId}, ${question.id}, '${opt}')">
          ${opt}
        </label>`).join('');
    }

    // âœ… Save answer
    async function saveAnswer(examId, questionId, answerText) {
      try {
        await fetch(`${apiBase}/${examId}/answer?studentId=${studentId}&questionId=${questionId}&answerText=${encodeURIComponent(answerText)}`, {
          method: 'POST'
        });
      } catch (err) { console.error('Error saving answer:', err); }
    }

    // âœ… Timer
    function startTimer(minutes) {
      let remainingSeconds = minutes * 60;
      updateTimerDisplay(remainingSeconds);
      timerInterval = setInterval(() => {
        remainingSeconds--;
        if (remainingSeconds <= 0) {
          clearInterval(timerInterval);
          autoSubmitExam();
        }
        updateTimerDisplay(remainingSeconds);
      }, 1000);
    }

    function updateTimerDisplay(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      document.getElementById('timer').textContent = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    async function autoSubmitExam() {
      alert('â° Time is up! Auto-submitting your exam.');
      await submitExam();
    }

    // âœ… Submit exam
    async function submitExam() {
      try {
        const res = await fetch(`${apiBase}/${examId}/submit?studentId=${studentId}`, { method: 'POST' });
        const result = await res.json();
        if (result.success) {
          alert(`âœ… Exam submitted successfully!\nCorrect: ${result.correctAnswers}/${result.totalQuestions}\nScore: ${result.percentage.toFixed(2)}%`);
          clearInterval(timerInterval);
          window.location.href = '/student/dashboard1.html';
        } else {
          alert(result.error || 'Exam submission failed.');
        }
      } catch (err) {
        alert(err.message || 'Error submitting exam.');
      }
    }

    // âœ… Log violation
    async function logViolation(eventMessage) {
      try {
        await fetch(`http://localhost:9090/api/proctor/log`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            studentId: studentId,
            examId: examId,
            eventType: "VIOLATION",
            eventMessage: eventMessage
          })
        });
      } catch (err) { console.error('Failed to log violation', err); }
    }

    document.getElementById('submitExamBtn').addEventListener('click', submitExam);
    window.onload = loadAssignedExams;
  </script>
</body>
</html>
